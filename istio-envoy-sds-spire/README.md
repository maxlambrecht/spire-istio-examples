
## Demo: use SPIRE as the certificate provider for the Istio Data Plane

This demo shows an example of an Istio deployment using SPIRE for providing certificates to the Envoy proxies
through the Envoy SDS API.

### Requirements

A kubernetes cluster running with [kubectl](https://kind.sigs.k8s.io/) configured.
(The easiest way to run a kubernetes cluster is [kind](https://kind.sigs.k8s.io/)). 

This demo uses the Istio release `1.14`. This version adds the support for the SPIRE integration through the Envoy SDS API.

### Steps

Change directory to demo and follow the next steps:

1. Download latest `istioctl` passing either `linux` or `macos` as parameter:

```
./download-istioctl linux
```

Verify that is working:

```
./istioctl version
```

The output should show `1.14.0`.

2. Deploy SPIRE to cluster

```
./deploy-spire
```

Verify:

```
kubectl get pod -n spire

NAME                READY   STATUS    RESTARTS   AGE
spire-agent-nbvcm   3/3     Running   0          39s
spire-server-0      1/1     Running   0          42s
```

3. Create SPIRE registration entries:

First you need to get the `demo-cluster` ID generated by SPIRE Server when the
SPIRE agent was attested.

```
./show-spire-cluster-id
```

Output:
```
time="2022-06-06T17:06:21Z" level=info msg="Node attestation was successful" spiffe_id="spiffe://example.org/spire/agent/k8s_psat/demo-cluster/fba76a57-14e6-4f47-8675-671840a3bdf5" subsystem_name=attestor trust_domain_id="spiffe://example.org"
```

This will show a log line with a `spiffe_id`, copy the path section after `demo_cluster`.
In the output example it is `fba76a57-14e6-4f47-8675-671840a3bdf5`

Run script and pass cluster ID as parameter:
```
./create-registration-entries fba76a57-14e6-4f47-8675-671840a3bdf5
```

The output will be a list of registration entries, for example:

```
Entry ID         : 624b344f-ca4d-4419-8959-4fdf45b318c0
SPIFFE ID        : spiffe://example.org/ns/default/sa/bookinfo-details
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/demo-cluster/fba76a57-14e6-4f47-8675-671840a3bdf5
Revision         : 0
TTL              : default
Selector         : k8s:ns:default
Selector         : k8s:pod-image:docker.io/istio/examples-bookinfo-details-v1@sha256:18e54f81689035019e1ac78f6d2e6483fcf1d94072d047315ab193cb2ab89ae5
Selector         : k8s:pod-label:app:details
Selector         : k8s:sa:bookinfo-details
Selector         : unix:uid:1337
```

4. Deploy `istio`

```
./deploy-istio
```

Output:

```
namespace/istio-system created
✔ Istio core installed                                                                                           
✔ Istiod installed                                                                                               
✔ Ingress gateways installed                                                                                     
✔ Installation complete                                                                                          Making this installation the default for injection and validation.
peerauthentication.security.istio.io/default created
```

5. Deploy `bookinfo` application

```
./deploy-bookinfo
```

Verify:

```
kubectl get pod

NAME                              READY   STATUS    RESTARTS   AGE
details-v2-85db5f7dc5-vh6ss       2/2     Running   0          117s
productpage-v1-7b9c849c5d-n9j72   2/2     Running   0          116s
ratings-v1-55dd8fb789-4b7v7       2/2     Running   0          117s
reviews-v1-597d6f76c8-xkmwd       2/2     Running   0          117s
reviews-v2-64677465f7-7c7nw       2/2     Running   0          117s
reviews-v3-dc6b79776-jkj7c        2/2     Running   0          117s
```

Wait until all the pods have their 2 containers ready (`READY 2/2`).

6. Test `bookinfo` application page

Forward traffic into the cluster:
```
./forward-port
```

Open in browser `http://localhost:8000/productpage`

### Make the bookinfo application fail

To test what happens when the identity policy for one service is missing, you can remove one of the
registration entries and then restart the corresponding pod.

Show registration entries:
```
./show-registration-entries
```

Look for the Entry ID of the service `bookinfo-details`:

```
Entry ID         : 624b344f-ca4d-4419-8959-4fdf45b318c0
SPIFFE ID        : spiffe://example.org/ns/default/sa/bookinfo-details
...
```

Copy the Entry ID and use the following script to delete it:

```
./delete-registration-entry 624b344f-ca4d-4419-8959-4fdf45b318c0
```

Then delete the pod of the `bookinfo-details` service to force it to restart:

```
kubectl delete pod $(kubectl get pod -l app=details -o jsonpath="{.items[0].metadata.name}")
```

Wait until the pod is recreated.

Reload the product page in the browser. Now the details section should display an error.
Strict mTLS is enabled, thus if one service cannot get its identity, it will not able to communicate
with any other service in the mesh.

#### Make it work again

Recreate the registration entry for the `bookinfo-details` service identity, passing the cluster ID:

```
./create-registration-entry-details fba76a57-14e6-4f47-8675-671840a3bdf5
```

Wait a few seconds for the certificates to be delivered to the `bookinfo-details` Envoy proxy (you should see a `READY 2/2` on the pod status).

Reload the `bookinfo` page on the browser. There should be no errors.

### Cleanup

```
./cleanup-all
```
